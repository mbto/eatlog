<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="jakarta.faces.core"
      xmlns:h="jakarta.faces.html"
      xmlns:cc="jakarta.faces.composite"
      xmlns:ui="jakarta.faces.facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:pe="http://primefaces.org/ui/extensions"
      xmlns:o="http://omnifaces.org/ui"
      xmlns:of="http://omnifaces.org/functions">
<f:metadata>
    <o:viewAction actionListener="#{requestLogin.onInvokeApplication()}" onPostback="false"/>
    <o:viewAction actionListener="#{requestParamsHolder.onInvokeApplication(false)}" onPostback="false"/>
</f:metadata>
<ui:composition template="../template/layout.xhtml">
<ui:define name="head">
<ui:fragment rendered="#{applicationHolder.devEnvironment}">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.7.2/css/all.css" />
</ui:fragment>
</ui:define>
<ui:define name="title">#{l10n['account']}</ui:define>
<ui:define name="centerForAll">
<ui:fragment rendered="#{sessionAccount.authed}">

    <p:panelGrid id="panelGridId" columns="2" style="margin:0 auto;width:700px;" styleClass="ui-panelgrid-blank">
        <p:row>
            <p:column colspan="2" style="margin:0 auto;">
                <ui:fragment rendered="#{sessionAccount.internalAccount.isBanned}">
                    <p:graphicImage value="#{resource['static/images/banned.jpg']}"
                                    style="display:block;margin:0 auto;border-radius:50%;"/>
                </ui:fragment>
                <ui:fragment rendered="#{!sessionAccount.internalAccount.isBanned}">
                    <p:graphicImage srcset="#{sessionAccount.internalAccount.siteAvatarUrl}"
                                    style="display:block;margin:0 auto;border-radius:50%;"
                                    rendered="#{not empty sessionAccount.internalAccount.siteAvatarUrl}"/>
                    <p:graphicImage value="#{resource['static/images/default.jpg']}"
                                    style="display:block;margin:0 auto;border-radius:50%;"
                                    rendered="#{empty sessionAccount.internalAccount.siteAvatarUrl}"/>
                </ui:fragment>
            </p:column>
        </p:row>
        <p:row>
            <p:column>
                <h:outputLabel value="#{l10n['date.registration']}"/>
            </p:column>
            <p:column>
                <h:outputText value="#{sessionAccount.internalAccount.createdAt}">
                    <f:convertDateTime pattern="dd.MM.yyyy HH:mm" type="localDateTime"/>
                </h:outputText><br/>
                <h:outputText value="#{dependentUtil.humanLifetime(sessionAccount.internalAccount.createdAt)}">
                    <f:convertDateTime pattern="dd.MM.yyyy HH:mm" type="localDateTime"/>
                </h:outputText>
            </p:column>
        </p:row>
        <p:row>
            <p:column>
                <h:outputLabel value="#{l10n['auth.previous.date']}"/>
            </p:column>
            <p:column>
                <h:outputText value="#{sessionAccount.internalAccount.lastauthAt}">
                    <f:convertDateTime pattern="dd.MM.yyyy HH:mm" type="localDateTime"/>
                </h:outputText><br/>
                <h:outputText value="#{dependentUtil.humanLifetime(sessionAccount.internalAccount.lastauthAt)}">
                    <f:convertDateTime pattern="dd.MM.yyyy HH:mm" type="localDateTime"/>
                </h:outputText>
            </p:column>
        </p:row>
        <p:row>
            <p:column>
                <h:outputLabel value="#{l10n['name']}"/>
            </p:column>
            <p:column>
                <h:outputText value="#{sessionAccount.internalAccount.name}" rendered="#{sessionAccount.internalAccount.isBanned}"/>
                <h:form id="nameFormId" rendered="#{!sessionAccount.internalAccount.isBanned}">
                    <p:inplace id="nameInplaceId" editor="true">
                        <p:ajax event="save"
                                listener="#{sessionAccount.updateName()}"
                                update="@form msgs siteVisitorsOutputPanelId"/>
                        <f:facet name="output">
                            <span style="white-space:nowrap;">
                            <i class="pi pi-cog"/>
                            <h:outputText value=" #{sessionAccount.internalAccount.name}"/>
                            </span>
                        </f:facet>
                        <f:facet name="input">
                            <p:inputText id="inNameId" value="#{sessionAccount.newName}" required="true" maxlength="32"
                                         requiredMessage="#{l10n['insert.name']}"
                                         onkeypress="if(event.keyCode == 13){return false;}"/>
                        </f:facet>
                    </p:inplace>
                </h:form>
            </p:column>
        </p:row>
        <p:row rendered="#{sessionAccount.geoInfo != null}">
            <p:column colspan="2" style="text-align:center;width:100%;">
                <h:outputText value="#{sessionAccount.geoInfo.locationByLocaleLanguage(sessionAccount.locale)}"/>
            </p:column>
        </p:row>
        <p:row>
            <p:column>
                <h:outputLabel value="#{l10n['roles']}"/>
            </p:column>
            <p:column>
                <ui:fragment rendered="#{!sessionAccount.internalAccount.calcedRoles.owner}">
                <h:outputText value="#{l10n['no']}"
                              rendered="#{empty sessionAccount.internalAccount.roles}"/>
                <h:form prependId="false">
                <p:selectManyCheckbox value="#{sessionAccount.internalAccount.roles}"
                                      layout="pageDirection" disabled="true"
                                      rendered="#{not empty sessionAccount.internalAccount.roles}">
                    <f:selectItems value="#{sessionAccount.internalAccount.roles}"
                                   var="roleName"
                                   itemValue="#{roleName}" itemLabel="#{roleName}"
                                   itemDisabled="true"/>
                </p:selectManyCheckbox>
                </h:form>
                </ui:fragment>
                <h:form id="rolesFormId" rendered="#{sessionAccount.internalAccount.calcedRoles.owner}">
                    <p:inplace id="rolesInplaceId" editor="true" disabled="#{sessionAccount.internalAccount.isBanned}">
                        <p:ajax event="save" listener="#{sessionAccount.updateRoles()}" update="@form msgs" />
                        <f:facet name="output">
<!--                        <i class="pi pi-cog"/>-->
                            <p:selectManyCheckbox value="#{sessionAccount.internalAccount.roles}"
                                                  layout="pageDirection" disabled="true">
                                <f:selectItems value="#{dependentUtil.mergeAllRoleNamesWithOthers(sessionAccount.internalAccount.roles)}"
                                               var="roleName"
                                               itemValue="#{roleName}" itemLabel="#{roleName}"
                                               itemDisabled="true"/>
                            </p:selectManyCheckbox>
                        </f:facet>
                        <f:facet name="input">
                            <p:importEnum type="com.github.mbto.eatlog.webapp.enums.RoleEnum" var="RoleEnum"/>
                            <p:selectManyCheckbox value="#{sessionAccount.internalAccount.roles}"
                                                  layout="pageDirection">
                                <f:selectItems value="#{dependentUtil.mergeAllRoleNamesWithOthers(sessionAccount.internalAccount.roles)}"
                                               var="roleName"
                                               itemValue="#{roleName}" itemLabel="#{roleName}"
                                               itemDisabled="#{roleName.equals(RoleEnum.OWNER.roleName)}"/>
                            </p:selectManyCheckbox>
                        </f:facet>
                    </p:inplace>
                </h:form>
            </p:column>
        </p:row>
        <p:row>
            <p:column>
                <h:outputLabel value="#{l10n['banned']}"/>
            </p:column>
            <p:column>
                <h:outputText value="#{sessionAccount.internalAccount.isBanned ? l10n['yes'] : l10n['no']}"/>
            </p:column>
        </p:row>
        <p:row rendered="#{sessionAccount.internalAccount.isBanned and not empty sessionAccount.internalAccount.bannedReason}">
            <p:column>
                <h:outputLabel value="#{l10n['banned.reason']}"/>
            </p:column>
            <p:column>
                <h:outputText value="#{sessionAccount.internalAccount.bannedReason}" style="white-space:pre-wrap;"/>
            </p:column>
        </p:row>
        <p:row>
            <p:column colspan="2" style="text-align:center;width:100%;">
                <p:button href="account?logout" value="#{l10n['logout']}" icon="pi pi-sign-out" />
            </p:column>
        </p:row>
    </p:panelGrid>
    <p:blockUI block="panelGridId" trigger="nameFormId:nameInplaceId rolesFormId:rolesInplaceId"/>
</ui:fragment>
<ui:fragment rendered="#{!sessionAccount.authed}">
    <h:form id="loginBtnsFormId">
    <p:panelGrid id="loginBtnsPanelGridId" columns="1" style="margin:0 auto;text-align:center;" styleClass="ui-panelgrid-blank">
        <p:commandButton value="login yandex"
                         actionListener="#{sessionAccount.devLogin('1493475743', 'Body Thanks', 'yandex')}"
                         action="/account.xhtml?faces-redirect=true"
                         process="@this" update="@this msgs"
                         onstart="PF('buiLoginForm').show()" oncomplete="PF('buiLoginForm').hide()"
                         style="text-align:left;" icon="fab fa-yandex"
                         disabled="#{sessionAccount.internalAccount.isBanned}"
                         rendered="#{applicationHolder.devEnvironment}"/>
        <h:outputText value="#{l10n['sign.in.with.yandex']}"/>
        <p:commandLink actionListener="#{requestLogin.redirectToOAuth20Provider()}"
                       process="@this" update="@this msgs"
                       onstart="PF('buiLoginForm').show()" oncomplete="PF('buiLoginForm').hide()">
            <p:graphicImage value="#{resource['static/images/yandex80.png']}" title="#{l10n['sign.in.with.yandex']}" />
        </p:commandLink>
    </p:panelGrid>
    <p:blockUI widgetVar="buiLoginForm" block="loginBtnsFormId:loginBtnsPanelGridId"/>
    </h:form>
</ui:fragment>
<p:messages id="msgs" for="msgs,nameFormId:inNameId" showDetail="true" skipDetailIfEqualsSummary="true"/>
<h:form id="ownerBntsForm" rendered="#{sessionAccount.internalAccount.calcedRoles.owner}">
<p:outputPanel style="text-align:center;">
<h:outputText value="test exception msgs buttons"/><br/>
<p:commandButton value="testThrowRuntimeException()"
                 actionListener="#{applicationHolder.testThrowRuntimeException()}"
                 process="@this" update="@this"
                 icon="pi pi-bolt"
                 onstart="PF('buiOwnerForm').show()" oncomplete="PF('buiOwnerForm').hide()"
                 disabled="#{sessionAccount.internalAccount.isBanned}"/>
<p:commandButton value="testThrowError()"
                 actionListener="#{applicationHolder.testThrowError()}"
                 process="@this" update="@this"
                 icon="pi pi-bolt"
                 onstart="PF('buiOwnerForm').show()" oncomplete="PF('buiOwnerForm').hide()"
                 disabled="#{sessionAccount.internalAccount.isBanned}"/>
<p:commandButton value="testDebugMe()"
                 actionListener="#{applicationHolder.testDebugMe()}"
                 process="@this" update="@this"
                 icon="pi pi-bolt"
                 onstart="PF('buiOwnerForm').show()" oncomplete="PF('buiOwnerForm').hide()"
                 disabled="#{sessionAccount.internalAccount.isBanned}"/>
</p:outputPanel>
<p:outputPanel deferred="true">
<p:dataTable id="cacheStatsdataListId" value="#{cacheManager.cacheNames}" var="cacheName"
             style="margin-top:10px;">
    <f:facet name="header">
        <h:outputText value="#{l10n['manage.caches']}"/>
    </f:facet>
    <p:column headerText="#{l10n['name']}">
        <h:outputText value="#{cacheName}"/>
    </p:column>
    <p:column headerText="#{l10n['manage']}" width="190">
        <p:commandButton value="evict #{cacheService.count(cacheName)} items"
                         actionListener="#{cacheService.evictAll(cacheName)}"
                         process="@this" update="ownerBntsForm:cacheStatsdataListId"
                         icon="pi pi-eraser"
                         onstart="PF('buiOwnerForm').show()" oncomplete="PF('buiOwnerForm').hide()"
                         disabled="#{sessionAccount.internalAccount.isBanned}"/>
    </p:column>
    <p:column headerText="#{l10n['stats']}">
        <h:outputText id="geoInfoByGeonameIdCache"
                      value="#{cacheService.cacheStats(cacheName).toString()}" style="white-space:pre-wrap;"/>
    </p:column>
</p:dataTable>
</p:outputPanel>
<p:blockUI block="ownerBntsForm" widgetVar="buiOwnerForm"/>
</h:form>
</ui:define>
<ui:define name="metrics"/>
</ui:composition>
</html>